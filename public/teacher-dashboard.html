<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }

        .dashboard-card {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 24px;
            transition: transform 0.2s;
            cursor: pointer;
        }

        .dashboard-card:hover {
            transform: translateY(-5px);
        }

        .student-item {
            display: flex;
            align-items: center;
            padding: 12px;
            border-radius: 8px;
            transition: background-color 0.2s;
        }

        .student-item:hover {
            background-color: #f9fafb;
        }
    </style>
</head>

<body class="bg-gray-100">
    <div id="message-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50">
        <div class="bg-white p-6 rounded-lg shadow-xl text-center">
            <h3 id="modal-message" class="text-lg font-medium"></h3>
            <button onclick="closeModal()"
                class="mt-4 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">Close</button>
        </div>
    </div>

    <div id="edit-student-modal"
        class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md">
            <h2 class="text-2xl font-bold mb-6 text-gray-800">Edit Student</h2>
            <form id="edit-student-form" class="space-y-4">
                <input type="hidden" id="edit-student-id">
                <div>
                    <label for="edit-name" class="block text-sm font-medium text-gray-700">Name</label>
                    <input type="text" id="edit-name" name="name"
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2"
                        required>
                </div>
                <div>
                    <label for="edit-roll" class="block text-sm font-medium text-gray-700">Roll Number</label>
                    <input type="text" id="edit-roll" name="roll_number"
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2"
                        required>
                </div>
                <div>
                    <label for="edit-dept" class="block text-sm font-medium text-gray-700">Department</label>
                    <input type="text" id="edit-dept" name="department"
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2"
                        required>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="closeEditModal()"
                        class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition-colors duration-200">Cancel</button>
                    <button type="submit"
                        class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors duration-200">Save
                        Changes</button>
                </div>
            </form>
        </div>
    </div>

    <div class="min-h-screen flex flex-col">
        <header class="bg-white shadow p-4 flex justify-between items-center flex-wrap gap-4">
            <h1 class="text-2xl font-bold text-gray-800">Teacher Dashboard</h1>
            <div class="flex items-center space-x-4">
                <span id="teacher-name" class="text-gray-600 font-medium">Mr. Shakib Khan</span>
                <button id="logout-btn"
                    class="px-4 py-2 bg-red-500 text-white rounded-full shadow hover:bg-red-600 transition-colors duration-200">Logout</button>
            </div>
        </header>

        <main class="container mx-auto p-6 flex-grow">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="dashboard-card">
                    <div class="flex items-center">
                        <div class="flex-shrink-0 bg-blue-100 text-blue-500 p-3 rounded-full mr-4">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 4.5c-4.418 0-8 3.582-8 8s3.582 8 8 8 8-3.582 8-8-3.582-8-8-8zm0 14.5c-3.589 0-6.5-2.911-6.5-6.5S8.411 5.5 12 5.5s6.5 2.911 6.5 6.5-2.911 6.5-6.5 6.5z" />
                            </svg>
                        </div>
                        <div>
                            <p class="text-gray-500">Total Students</p>
                            <h2 id="total-students" class="text-3xl font-semibold text-gray-800">0</h2>
                        </div>
                    </div>
                </div>

                <div class="dashboard-card">
                    <div class="flex items-center">
                        <div class="flex-shrink-0 bg-green-100 text-green-500 p-3 rounded-full mr-4">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                        </div>
                        <div>
                            <p class="text-gray-500">Total Classes</p>
                            <h2 id="total-classes" class="text-3xl font-semibold text-gray-800">1</h2>
                        </div>
                    </div>
                </div>

                <div class="dashboard-card">
                    <div class="flex items-center">
                        <div class="flex-shrink-0 bg-yellow-100 text-yellow-500 p-3 rounded-full mr-4">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                        </div>
                        <div>
                            <p class="text-gray-500">Pending Results</p>
                            <h2 id="pending-results" class="text-3xl font-semibold text-gray-800">0</h2>
                        </div>
                    </div>
                </div>

                <div class="dashboard-card">
                    <div class="flex items-center">
                        <div class="flex-shrink-0 bg-purple-100 text-purple-500 p-3 rounded-full mr-4">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 4c-4.418 0-8 3.582-8 8s3.582 8 8 8 8-3.582 8-8-3.582-8-8-8zm-5 8h10M7 12a1 1 0 100 0z" />
                            </svg>
                        </div>
                        <div>
                            <p class="text-gray-500">Notices</p>
                            <h2 id="notices-count" class="text-3xl font-semibold text-gray-800">0</h2>
                        </div>
                    </div>
                </div>
            </div>

            <div class="dashboard-card mb-8">
                <h3 class="text-xl font-semibold text-gray-700 mb-4">Recent Students</h3>
                <div id="recent-students-list" class="space-y-2">
                    <p class="text-gray-500 text-center">Loading student data...</p>
                </div>
            </div>
            <div class="flex justify-center my-8">
                <button id="add-student-btn"
                    class="px-6 py-3 bg-indigo-600 text-white rounded-lg shadow-md hover:bg-indigo-700 transition-colors duration-200 text-lg font-semibold">
                    Add New Student
                </button>
            </div>

            <div id="add-student-modal"
                class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50">
                <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md">
                    <h2 class="text-2xl font-bold mb-6 text-gray-800">Add New Student</h2>
                    <form id="add-student-form" class="space-y-4">
                        <div>
                            <label for="new-name" class="block text-sm font-medium text-gray-700">Name</label>
                            <input type="text" id="new-name" name="name"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" required>
                        </div>
                        <div>
                            <label for="new-roll" class="block text-sm font-medium text-gray-700">Roll Number</label>
                            <input type="text" id="new-roll" name="roll_number"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" required>
                        </div>
                        <div>
                            <label for="new-reg" class="block text-sm font-medium text-gray-700">Registration
                                Number</label>
                            <input type="text" id="new-reg" name="registration_number"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" required>
                        </div>
                        <div>
                            <label for="new-dept" class="block text-sm font-medium text-gray-700">Department</label>
                            <input type="text" id="new-dept" name="department"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" required>
                        </div>
                        <div>
                            <label for="new-session" class="block text-sm font-medium text-gray-700">Session</label>
                            <input type="text" id="new-session" name="session"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" required>
                        </div>
                        <div>
                            <label for="new-sem" class="block text-sm font-medium text-gray-700">Semester</label>
                            <input type="text" id="new-sem" name="semester"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" required>
                        </div>
                        <div>
                            <label for="new-phone" class="block text-sm font-medium text-gray-700">Phone Number</label>
                            <input type="text" id="new-phone" name="phone_number"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" required>
                        </div>
                        <div class="flex justify-end space-x-3">
                            <button type="button" onclick="closeAddStudentModal()"
                                class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition-colors duration-200">Cancel</button>
                            <button type="submit"
                                class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors duration-200">Add
                                Student</button>
                        </div>
                    </form>
                </div>
            </div>
        </main>

        <footer class="bg-gray-800 text-white text-center p-4 mt-6">
            <p>&copy; 2024 BPI Portal. All rights reserved.</p>
        </footer>
    </div>

    <script>
        // UI Elements
        const logoutBtn = document.getElementById('logout-btn');
        const totalStudentsEl = document.getElementById('total-students');
        const recentStudentsListEl = document.getElementById('recent-students-list');
        const teacherNameEl = document.getElementById('teacher-name');
        const messageModal = document.getElementById('message-modal');
        const modalMessage = document.getElementById('modal-message');
        const editStudentModal = document.getElementById('edit-student-modal');
        const editStudentForm = document.getElementById('edit-student-form');
        const editStudentIdInput = document.getElementById('edit-student-id');
        const editNameInput = document.getElementById('edit-name');
        const editRollInput = document.getElementById('edit-roll');
        const editDeptInput = document.getElementById('edit-dept');

        // Functions for modal and actions
        function showModal(message) {
            modalMessage.textContent = message;
            messageModal.classList.remove('hidden');
        }

        function closeModal() {
            messageModal.classList.add('hidden');
        }

        function closeEditModal() {
            editStudentModal.classList.add('hidden');
        }

        async function fetchDashboardData() {
            try {
                const response = await fetch('/dashboard-data');
                const data = await response.json();

                if (response.ok) {
                    totalStudentsEl.textContent = data.totalStudents;
                    document.getElementById('total-classes').textContent = data.totalClasses;
                    document.getElementById('pending-results').textContent = data.pendingResults;
                    document.getElementById('notices-count').textContent = '0'; // Assumed value
                    teacherNameEl.textContent = data.teacherName;

                    renderStudentList(data.recentStudents);
                } else {
                    showModal('Failed to fetch dashboard data.');
                }
            } catch (error) {
                console.error('Fetch error:', error);
                showModal('Server error. Please try again later.');
            }
        }

        function renderStudentList(students) {
            recentStudentsListEl.innerHTML = '';
            if (students && students.length > 0) {
                students.forEach(student => {
                    const studentItem = document.createElement('div');
                    studentItem.className = 'student-item flex items-center justify-between bg-white shadow-sm rounded-lg p-4 mb-2';
                    studentItem.innerHTML = `
                    <div>
                        <p class="font-semibold text-gray-800">${student.name}</p>
                        <p class="text-sm text-gray-500">Roll: ${student.roll_number} | Dept: ${student.department}</p>
                    </div>
                    <div class="flex items-center space-x-2">
                        <button onclick='handleEditClick(${JSON.stringify(student)})' class="edit-btn px-3 py-1 bg-blue-500 text-white rounded-md text-sm hover:bg-blue-600 transition-colors duration-200">Edit</button>
                        <button onclick="handleDeleteClick(${student.id})" class="delete-btn px-3 py-1 bg-red-500 text-white rounded-md text-sm hover:bg-red-600 transition-colors duration-200">Delete</button>
                    </div>
                `;
                    recentStudentsListEl.appendChild(studentItem);
                });
            } else {
                recentStudentsListEl.innerHTML = '<p class="text-gray-500 text-center">No students found.</p>';
            }
        }

        async function handleEditClick(student) {
            editStudentIdInput.value = student.id;
            editNameInput.value = student.name;
            editRollInput.value = student.roll_number;
            editDeptInput.value = student.department;
            editStudentModal.classList.remove('hidden');
        }

        async function handleDeleteClick(studentId) {
            if (confirm("Are you sure you want to delete this student?")) {
                try {
                    const response = await fetch('/delete-student', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ student_id: studentId })
                    });

                    const result = await response.json();
                    if (response.ok) {
                        showModal(result.message);
                        fetchDashboardData();
                    } else {
                        showModal(result.message);
                    }
                } catch (error) {
                    showModal('Failed to delete student. Server error.');
                }
            }
        }

        editStudentForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const studentId = editStudentIdInput.value;
            const updatedData = {
                student_id: studentId,
                name: editNameInput.value,
                roll_number: editRollInput.value,
                department: editDeptInput.value
            };

            try {
                const response = await fetch('/edit-student', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updatedData)
                });

                const result = await response.json();
                if (response.ok) {
                    showModal(result.message);
                    closeEditModal();
                    fetchDashboardData();
                } else {
                    showModal(result.message);
                }
            } catch (error) {
                showModal('Failed to edit student. Server error.');
            }
        });

        logoutBtn.addEventListener('click', async () => {
            try {
                const response = await fetch('/logout', { method: 'POST' });
                if (response.ok) {
                    window.location.href = '/teacher-login.html';
                } else {
                    showModal('Logout failed. Please try again.');
                }
            } catch (error) {
                console.error('Logout error:', error);
                showModal('An error occurred during logout.');
            }
        });
        // Add these new element selectors
        const addStudentBtn = document.getElementById('add-student-btn');
        const addStudentModal = document.getElementById('add-student-modal');
        const addStudentForm = document.getElementById('add-student-form');

        // Function to open the add student modal
        function openAddStudentModal() {
            addStudentModal.classList.remove('hidden');
        }

        // Function to close the add student modal
        function closeAddStudentModal() {
            addStudentModal.classList.add('hidden');
            addStudentForm.reset(); // Reset form fields
        }

        // Event listener for the Add New Student button
        addStudentBtn.addEventListener('click', openAddStudentModal);

        // Event listener for the form submission
        addStudentForm.addEventListener('submit', async (event) => {
            event.preventDefault();

            const newStudentData = {
                name: document.getElementById('new-name').value,
                roll_number: document.getElementById('new-roll').value,
                registration_number: document.getElementById('new-reg').value,
                department: document.getElementById('new-dept').value,
                session: document.getElementById('new-session').value,
                semester: document.getElementById('new-sem').value,
                phone_number: document.getElementById('new-phone').value
            };

            try {
                const response = await fetch('/add-student', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(newStudentData)
                });

                const result = await response.json();
                if (response.ok) {
                    showModal(result.message);
                    closeAddStudentModal();
                    fetchDashboardData(); // Refresh the list to show the new student
                } else {
                    showModal(result.message);
                }
            } catch (error) {
                showModal('Failed to add new student. Server error.');
                console.error('Error:', error);
            }
        });

        document.addEventListener('DOMContentLoaded', fetchDashboardData);
    </script>
</body>

</html>