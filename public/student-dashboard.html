<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .dashboard-card {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 24px;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div id="message-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50">
        <div class="bg-white p-6 rounded-lg shadow-xl text-center">
            <h3 id="modal-message" class="text-lg font-medium"></h3>
            <button onclick="closeModal()" class="mt-4 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">Close</button>
        </div>
    </div>

    <div class="min-h-screen flex flex-col">
        <!-- Header -->
        <header class="bg-white shadow p-4 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-gray-800">Student Dashboard</h1>
            <div class="flex items-center space-x-4">
                <span id="student-name" class="text-gray-600 font-medium"></span>
                <button id="logout-btn" class="px-4 py-2 bg-red-500 text-white rounded-lg shadow hover:bg-red-600 transition-colors duration-200">Logout</button>
            </div>
        </header>

        <!-- Main Content -->
        <main class="container mx-auto p-6 flex-grow">
            <!-- Student Profile Section -->
            <div class="dashboard-card mb-8">
                <div class="flex items-center space-x-6">
                    <img id="student-profile-pic" class="h-24 w-24 rounded-full border-4 border-gray-200" src="https://placehold.co/100x100/E5E7EB/4B5563?text=Student" alt="Student Profile Picture">
                    <div>
                        <h2 id="student-profile-name" class="text-3xl font-bold text-gray-800"></h2>
                        <p class="text-lg text-gray-600">Roll: <span id="student-roll"></span> | Reg: <span id="student-reg"></span></p>
                        <p class="text-md text-gray-500">Dept: <span id="student-dept"></span> | Sem: <span id="student-sem"></span></p>
                    </div>
                </div>
            </div>

            <!-- Dashboard Overview Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                <div class="dashboard-card text-center">
                    <h3 class="text-xl font-semibold text-gray-700">Total Marks</h3>
                    <p id="total-marks" class="text-4xl font-bold text-blue-600 mt-2">0</p>
                </div>
                <div class="dashboard-card text-center">
                    <h3 class="text-xl font-semibold text-gray-700">Attendance</h3>
                    <p id="total-attendance" class="text-4xl font-bold text-green-600 mt-2">0%</p>
                </div>
                <div class="dashboard-card text-center">
                    <h3 class="text-xl font-semibold text-gray-700">Total Courses</h3>
                    <p id="total-courses" class="text-4xl font-bold text-yellow-600 mt-2">0</p>
                </div>
            </div>

            <!-- Results Section -->
            <div class="dashboard-card mb-8">
                <h3 class="text-xl font-semibold text-gray-700 mb-4">Exam Results</h3>
                <div id="results-table-container" class="overflow-x-auto">
                    <table class="min-w-full bg-white rounded-lg shadow-sm">
                        <thead>
                            <tr class="bg-gray-200 text-left text-gray-600">
                                <th class="py-3 px-4 font-semibold">Course</th>
                                <th class="py-3 px-4 font-semibold">Marks</th>
                            </tr>
                        </thead>
                        <tbody id="results-table-body">
                            <!-- Results will be rendered here dynamically -->
                        </tbody>
                    </table>
                </div>
                <div id="no-results-message" class="hidden text-center text-gray-500 py-8">
                    <p>No exam results found.</p>
                </div>
            </div>

            <!-- Attendance Section -->
            <div class="dashboard-card mb-8">
                <h3 class="text-xl font-semibold text-gray-700 mb-4">Attendance Record</h3>
                <div id="attendance-table-container" class="overflow-x-auto">
                    <table class="min-w-full bg-white rounded-lg shadow-sm">
                        <thead>
                            <tr class="bg-gray-200 text-left text-gray-600">
                                <th class="py-3 px-4 font-semibold">Date</th>
                                <th class="py-3 px-4 font-semibold">Status</th>
                            </tr>
                        </thead>
                        <tbody id="attendance-table-body">
                            <!-- Attendance records will be rendered here dynamically -->
                        </tbody>
                    </table>
                </div>
                <div id="no-attendance-message" class="hidden text-center text-gray-500 py-8">
                    <p>No attendance records found.</p>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="bg-gray-800 text-white text-center p-4 mt-6">
            <p>&copy; 2024 BPI Portal. All rights reserved.</p>
        </footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const logoutBtn = document.getElementById('logout-btn');
            const studentNameEl = document.getElementById('student-name');
            const studentProfileNameEl = document.getElementById('student-profile-name');
            const studentRollEl = document.getElementById('student-roll');
            const studentRegEl = document.getElementById('student-reg');
            const studentDeptEl = document.getElementById('student-dept');
            const studentSemEl = document.getElementById('student-sem');
            const totalMarksEl = document.getElementById('total-marks');
            const totalAttendanceEl = document.getElementById('total-attendance');
            const totalCoursesEl = document.getElementById('total-courses');
            const resultsTableBody = document.getElementById('results-table-body');
            const attendanceTableBody = document.getElementById('attendance-table-body');
            const messageModal = document.getElementById('message-modal');
            const modalMessage = document.getElementById('modal-message');

            function showModal(message) {
                modalMessage.textContent = message;
                messageModal.classList.remove('hidden');
            }

            window.closeModal = function() {
                messageModal.classList.add('hidden');
            }

            // Get student ID from URL
            const urlParams = new URLSearchParams(window.location.search);
            const studentId = urlParams.get('id');

            if (!studentId) {
                showModal('Student ID is missing. Redirecting to login.');
                setTimeout(() => window.location.href = '/', 2000);
                return;
            }

            // Fetch student data
            async function fetchStudentData() {
                try {
                    const response = await fetch(`/student-dashboard-data/${studentId}`);
                    if (!response.ok) {
                        showModal('Failed to fetch student data.');
                        return;
                    }
                    const data = await response.json();
                    
                    const { student, results, attendance } = data;

                    // Update profile info
                    studentNameEl.textContent = `Welcome, ${student.name}`;
                    studentProfileNameEl.textContent = student.name;
                    studentRollEl.textContent = student.roll_number;
                    studentRegEl.textContent = student.registration_number;
                    studentDeptEl.textContent = student.department;
                    studentSemEl.textContent = student.semester;

                    // Calculate and display summary stats
                    let totalMarks = 0;
                    if (results && results.length > 0) {
                        totalMarks = results.reduce((sum, result) => sum + result.marks, 0);
                        totalMarksEl.textContent = totalMarks;
                        totalCoursesEl.textContent = results.length;
                        renderResults(results);
                    } else {
                        document.getElementById('no-results-message').classList.remove('hidden');
                    }

                    if (attendance && attendance.length > 0) {
                        const totalClasses = attendance.length;
                        const presentClasses = attendance.filter(record => record.status === 'Present').length;
                        const attendancePercentage = (presentClasses / totalClasses) * 100;
                        totalAttendanceEl.textContent = `${attendancePercentage.toFixed(2)}%`;
                        renderAttendance(attendance);
                    } else {
                         document.getElementById('no-attendance-message').classList.remove('hidden');
                    }
                    
                } catch (error) {
                    console.error('Error fetching student data:', error);
                    showModal('An error occurred. Please try again later.');
                }
            }

            // Render results table
            function renderResults(results) {
                resultsTableBody.innerHTML = '';
                results.forEach(result => {
                    const row = document.createElement('tr');
                    row.className = 'border-b border-gray-200 hover:bg-gray-100';
                    row.innerHTML = `
                        <td class="py-3 px-4">${result.course}</td>
                        <td class="py-3 px-4">${result.marks}</td>
                    `;
                    resultsTableBody.appendChild(row);
                });
            }

            // Render attendance table
            function renderAttendance(attendance) {
                attendanceTableBody.innerHTML = '';
                attendance.forEach(record => {
                    const row = document.createElement('tr');
                    row.className = 'border-b border-gray-200 hover:bg-gray-100';
                    const statusColor = record.status === 'Present' ? 'text-green-500' : 'text-red-500';
                    row.innerHTML = `
                        <td class="py-3 px-4">${record.date}</td>
                        <td class="py-3 px-4"><span class="${statusColor}">${record.status}</span></td>
                    `;
                    attendanceTableBody.appendChild(row);
                });
            }

            // Logout functionality
            logoutBtn.addEventListener('click', async () => {
                try {
                    const response = await fetch('/logout', { method: 'POST' });
                    if (response.ok) {
                        window.location.href = '/student-login.html';
                    } else {
                        showModal('Logout failed. Please try again.');
                    }
                } catch (error) {
                    console.error('Logout error:', error);
                    showModal('An error occurred during logout.');
                }
            });

            // Initial data fetch
            fetchStudentData();
        });
    </script>
</body>
</html>
