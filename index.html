<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BPI Student Portal</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        /* Custom styles for the attendance bar */
        #attendance-chart-container {
            width: 100%;
            height: 30px;
            background-color: #e5e7eb;
            border-radius: 9999px;
            overflow: hidden;
        }
        #attendance-chart-bar {
            height: 100%;
            border-radius: 9999px;
            transition: width 0.5s ease-in-out, background-color 0.5s ease-in-out;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 0.875rem; /* text-sm */
        }
        /* Style for the modal overlay */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        /* Simple fade-in animation for modal */
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        .animate-fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <div id="app" class="w-full max-w-4xl bg-white rounded-2xl shadow-xl overflow-hidden flex flex-col items-center justify-center">

        <!-- Login Section -->
        <div id="login-section" class="p-8 flex flex-col items-center justify-center text-center w-full">
            <h1 class="text-3xl font-bold mb-2 text-gray-800">BPI Student Portal</h1>
            <p class="text-gray-500 mb-6">Login to your account</p>
            <div class="w-full max-w-sm space-y-4">
                <div>
                    <input id="user-id-input" type="text" placeholder="User ID (e.g., 12345)" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <input id="password-input" type="password" placeholder="Password" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <button id="login-button" class="w-full bg-blue-600 text-white font-semibold py-3 rounded-xl hover:bg-blue-700 transition duration-300">Log In</button>
            </div>
            <p id="login-message" class="mt-4 text-sm text-red-500 hidden">Invalid user ID or password.</p>
        </div>

        <!-- Dashboard Section (Initially Hidden) -->
        <div id="dashboard-section" class="hidden w-full">
            <!-- Header -->
            <header class="bg-blue-600 text-white p-6 md:p-8 flex flex-col md:flex-row justify-between items-start md:items-center">
                <div class="flex-1">
                    <h1 class="text-3xl md:text-4xl font-bold mb-1 md:mb-0">BPI Student Portal</h1>
                    <p class="text-blue-200 text-sm">Welcome, Student!</p>
                </div>
                <div class="mt-4 md:mt-0 md:text-right">
                    <p class="text-sm font-light text-blue-200">Your User ID:</p>
                    <p id="user-id" class="text-base font-medium text-white break-words"></p>
                </div>
            </header>

            <!-- Main Content -->
            <main class="p-6 md:p-8 grid grid-cols-1 gap-6 md:grid-cols-2 lg:grid-cols-3">
                <!-- Loading Indicator -->
                <div id="loading" class="col-span-full text-center py-12 text-gray-500 font-medium hidden">
                    Loading student data...
                </div>
                
                <!-- Student Info Card -->
                <div id="student-info-card" class="bg-gray-50 p-6 rounded-2xl shadow-sm border border-gray-200 hidden">
                    <h2 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-600 mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                        Student Information
                    </h2>
                    <div class="space-y-3 text-sm text-gray-700">
                        <p><strong>Name:</strong> <span id="student-name" class="font-medium text-gray-900">N/A</span></p>
                        <p><strong>Student ID:</strong> <span id="student-id" class="font-medium text-gray-900">N/A</span></p>
                        <p><strong>Major:</strong> <span id="student-major" class="font-medium text-gray-900">N/A</span></p>
                        <p><strong>Enrollment Year:</strong> <span id="student-year" class="font-medium text-gray-900">N/A</span></p>
                    </div>
                </div>

                <!-- Results Card -->
                <div id="results-card" class="bg-gray-50 p-6 rounded-2xl shadow-sm border border-gray-200 hidden lg:col-span-2">
                    <h2 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-600 mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><line x1="10" y1="9" x2="8" y2="9"/></svg>
                        Results
                    </h2>
                    <div id="results-table-container" class="overflow-x-auto">
                        <table class="w-full text-left text-sm text-gray-600 rounded-lg overflow-hidden">
                            <thead class="bg-gray-200">
                                <tr>
                                    <th class="p-3 font-medium">Subject</th>
                                    <th class="p-3 font-medium">Grade</th>
                                    <th class="p-3 font-medium">Status</th>
                                    <th class="p-3 font-medium">Analysis</th>
                                </tr>
                            </thead>
                            <tbody id="results-table" class="bg-white">
                                <!-- Results will be injected here -->
                            </tbody>
                        </table>
                    </div>
                    <div id="no-results" class="text-center py-4 text-gray-500 hidden">No results available yet.</div>
                </div>

                <!-- Attendance Card -->
                <div id="attendance-card" class="bg-gray-50 p-6 rounded-2xl shadow-sm border border-gray-200 hidden">
                    <h2 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-600 mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                        Attendance
                    </h2>
                    <div class="space-y-3 text-sm text-gray-700">
                        <p><strong>Total Attendance:</strong> <span id="attendance-rate-text" class="font-medium text-gray-900">N/A</span></p>
                        <div id="attendance-chart-container">
                            <div id="attendance-chart-bar"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Performance Card -->
                <div id="performance-card" class="bg-gray-50 p-6 rounded-2xl shadow-sm border border-gray-200 hidden">
                    <h2 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-600 mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v18h18"/><path d="M18 17l-3-3-4 4-5-5-2 2"/></svg>
                        Performance Summary
                    </h2>
                    <div class="space-y-3 text-sm text-gray-700">
                        <p><strong>GPA:</strong> <span id="gpa" class="font-medium text-gray-900">N/A</span></p>
                        <p><strong>Last Exam Grade:</strong> <span id="last-grade" class="font-medium text-gray-900">N/A</span></p>
                    </div>
                    <button id="insight-button" class="mt-4 w-full bg-blue-600 text-white font-semibold py-3 rounded-xl hover:bg-blue-700 transition duration-300">
                        Performance Insights âœ¨
                    </button>
                </div>
                
                 <!-- Upcoming Events Card -->
                <div id="events-card" class="bg-gray-50 p-6 rounded-2xl shadow-sm border border-gray-200 hidden">
                    <h2 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-600 mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                        Upcoming Events
                    </h2>
                    <div id="events-list" class="space-y-3 text-sm text-gray-700">
                        <!-- Events will be injected here -->
                    </div>
                    <div id="no-events" class="text-center py-4 text-gray-500 hidden">No upcoming events.</div>
                </div>

            </main>
        </div>

        <!-- Message Box for Alerts -->
        <div id="message-box" class="fixed inset-x-0 bottom-4 flex justify-center z-50 transition-opacity duration-300 opacity-0">
            <div class="bg-red-500 text-white p-4 rounded-xl shadow-lg flex items-center space-x-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2h.01a1 1 0 000-2H9z" clip-rule="evenodd"/></svg>
                <span id="message-text" class="font-medium"></span>
            </div>
        </div>

    </div>
    
    <!-- Modal for Gemini API Response -->
    <div id="insight-modal" class="modal-overlay hidden">
        <div class="bg-white p-8 rounded-2xl shadow-2xl max-w-lg w-full m-4 relative animate-fade-in">
            <button id="close-modal-btn" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 transition">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
            </button>
            <h3 id="modal-title" class="text-2xl font-bold text-gray-800 mb-4"></h3>
            <div id="modal-content" class="text-gray-700 leading-relaxed overflow-y-auto max-h-96">
                <!-- Content will be injected here -->
            </div>
            <div id="audio-controls" class="mt-4 flex items-center space-x-2 hidden">
                <button id="play-audio-btn" class="bg-blue-500 text-white px-4 py-2 rounded-full hover:bg-blue-600 transition duration-300 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5 mr-1"><path fill-rule="evenodd" d="M4.5 5.653c0-1.426 1.94-2.285 3.186-1.504l11.712 7.21c1.246.765 1.246 2.24 0 3.004l-11.712 7.21c-1.246.781-3.186-.08-3.186-1.504V5.653z" clip-rule="evenodd" /></svg>
                    Listen
                </button>
                <span id="audio-loading" class="text-sm text-gray-500 hidden">Generating audio...</span>
            </div>
            <div id="modal-loading" class="text-center py-8 hidden">
                <div class="animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-blue-500 mx-auto"></div>
                <p class="mt-2 text-blue-500">Generating insights...</p>
            </div>
        </div>
    </div>

    <script type="module">
        // Import Firebase libraries
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Helper functions for TTS
        function base64ToArrayBuffer(base64) {
            const binaryString = atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        function pcmToWav(pcmData, sampleRate) {
            const pcm16 = new Int16Array(pcmData);
            const numChannels = 1;
            const sampleBits = 16;
            const byteRate = (sampleRate * numChannels * sampleBits) / 8;
            const blockAlign = (numChannels * sampleBits) / 8;
            const dataSize = pcm16.byteLength;
            const buffer = new ArrayBuffer(44 + dataSize);
            const view = new DataView(buffer);

            let offset = 0;

            function writeString(view, offset, string) {
                for (let i = 0; i < string.length; i++) {
                    view.setUint8(offset + i, string.charCodeAt(i));
                }
            }

            // RIFF header
            writeString(view, offset, 'RIFF'); offset += 4;
            view.setUint32(offset, 36 + dataSize, true); offset += 4;
            writeString(view, offset, 'WAVE'); offset += 4;
            
            // FMT sub-chunk
            writeString(view, offset, 'fmt '); offset += 4;
            view.setUint32(offset, 16, true); offset += 4; // Sub-chunk size
            view.setUint16(offset, 1, true); offset += 2; // Audio format (1 for PCM)
            view.setUint16(offset, numChannels, true); offset += 2; // Number of channels
            view.setUint32(offset, sampleRate, true); offset += 4; // Sample rate
            view.setUint32(offset, byteRate, true); offset += 4; // Byte rate
            view.setUint16(offset, blockAlign, true); offset += 2; // Block align
            view.setUint16(offset, sampleBits, true); offset += 2; // Bits per sample

            // DATA sub-chunk
            writeString(view, offset, 'data'); offset += 4;
            view.setUint32(offset, dataSize, true); offset += 4;
            
            // Write the PCM data
            const pcmBytes = new Uint8Array(pcmData);
            for (let i = 0; i < dataSize; i++) {
                view.setUint8(offset + i, pcmBytes[i]);
            }
            
            return new Blob([view], { type: 'audio/wav' });
        }
        
        // Function to display an alert message
        function showMessage(message) {
            const msgBox = document.getElementById('message-box');
            const msgText = document.getElementById('message-text');
            msgText.textContent = message;
            msgBox.classList.remove('opacity-0', 'scale-95');
            msgBox.classList.add('opacity-100', 'scale-100');
            setTimeout(() => {
                msgBox.classList.remove('opacity-100', 'scale-100');
                msgBox.classList.add('opacity-0', 'scale-95');
            }, 5000);
        }

        // --- Firebase & Main App Logic ---
        
        let db, auth, userId;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Initialize Firebase
        if (Object.keys(firebaseConfig).length > 0) {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            if (initialAuthToken) {
                signInWithCustomToken(auth, initialAuthToken).catch(e => {
                    console.error("Custom token sign-in failed:", e);
                    signInAnonymously(auth);
                });
            } else {
                signInAnonymously(auth);
            }
        } else {
            showMessage("Firebase configuration is missing.");
            console.error("Firebase config is not available.");
        }
        
        // Listen for auth state changes
        auth.onAuthStateChanged(user => {
            if (user) {
                userId = user.uid;
                document.getElementById('user-id-input').value = userId;
                document.getElementById('login-button').textContent = "Continue";
            } else {
                userId = null;
                document.getElementById('login-button').textContent = "Log In";
            }
        });

        // Add login event listener
        document.getElementById('login-button').addEventListener('click', () => {
            const userIdInput = document.getElementById('user-id-input').value.trim();
            const passwordInput = document.getElementById('password-input').value.trim();
            const loginMessage = document.getElementById('login-message');

            // Hardcoded password check for a simple demo
            if (passwordInput === 'password') {
                if (userIdInput === userId) {
                    loginMessage.classList.add('hidden');
                    showDashboard(userIdInput);
                } else {
                    loginMessage.textContent = "Invalid User ID for this session.";
                    loginMessage.classList.remove('hidden');
                }
            } else {
                loginMessage.textContent = "Invalid password.";
                loginMessage.classList.remove('hidden');
            }
        });
        
        // Function to create a sample student data document
        async function createSampleData(studentId) {
            const studentDocRef = doc(db, 'artifacts', appId, 'users', studentId, 'studentData', 'profile');
            const sampleData = {
                name: 'Jane Doe',
                studentId: studentId,
                major: 'Computer Science',
                enrollmentYear: 2023,
                results: [
                    { subject: 'Physics', grade: 'B+', status: 'Passed' },
                    { subject: 'Chemistry', grade: 'A-', status: 'Passed' },
                    { subject: 'Mathematics', grade: 'C+', status: 'Passed' },
                    { subject: 'English', grade: 'B', status: 'Passed' },
                ],
                attendance: { attended: 15, total: 20 },
                performance: { gpa: 3.2, lastGrade: 'B+' },
                upcomingEvents: [
                    { title: 'Midterm Exam', date: 'October 15, 2024' },
                    { title: 'Project Submission', date: 'November 1, 2024' },
                ],
            };
            try {
                await setDoc(studentDocRef, sampleData);
                console.log("Sample data created successfully.");
                showMessage("Sample data created! The dashboard will now load.");
            } catch (e) {
                console.error("Error creating sample data:", e);
                showMessage("Failed to create sample data. Please try again.");
            }
        }

        // Function to show the dashboard and fetch data
        function showDashboard(studentId) {
            document.getElementById('login-section').classList.add('hidden');
            document.getElementById('dashboard-section').classList.remove('hidden');
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('user-id').textContent = studentId;

            const studentDocRef = doc(db, 'artifacts', appId, 'users', studentId, 'studentData', 'profile');

            onSnapshot(studentDocRef, (docSnap) => {
                document.getElementById('loading').classList.add('hidden');
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    updateUI(data);
                    document.getElementById('student-info-card').classList.remove('hidden');
                    document.getElementById('results-card').classList.remove('hidden');
                    document.getElementById('attendance-card').classList.remove('hidden');
                    document.getElementById('performance-card').classList.remove('hidden');
                    document.getElementById('events-card').classList.remove('hidden');
                } else {
                    document.getElementById('loading').innerHTML = `
                        <p class="mb-4">Student data not found for this user ID.</p>
                        <button id="create-data-btn" class="bg-blue-600 text-white font-semibold py-3 px-6 rounded-xl hover:bg-blue-700 transition duration-300">
                            Create Sample Data
                        </button>
                    `;
                    document.getElementById('loading').classList.remove('hidden');
                    document.getElementById('create-data-btn').addEventListener('click', () => {
                        createSampleData(studentId);
                    });
                }
            }, (error) => {
                console.error("Error getting document:", error);
                document.getElementById('loading').innerHTML = `<p class="text-red-500">An error occurred while loading data.</p>`;
                document.getElementById('loading').classList.remove('hidden');
                showMessage("An error occurred while loading data.");
            });
        }
        
        // Function to update the UI with data
        function updateUI(data) {
            // Student Info
            document.getElementById('student-name').textContent = data.name || "N/A";
            document.getElementById('student-id').textContent = data.studentId || "N/A";
            document.getElementById('student-major').textContent = data.major || "N/A";
            document.getElementById('student-year').textContent = data.enrollmentYear || "N/A";

            // Results
            const resultsTable = document.getElementById('results-table');
            resultsTable.innerHTML = ""; // Clear existing data
            if (data.results && data.results.length > 0) {
                document.getElementById('no-results').classList.add('hidden');
                data.results.forEach(result => {
                    const row = document.createElement('tr');
                    const gradeColor = result.grade.startsWith("A") ? 'text-green-600' :
                                       result.grade.startsWith("B") ? 'text-blue-600' :
                                       'text-red-600';
                    row.innerHTML = `
                        <td class="p-3 border-t">${result.subject}</td>
                        <td class="p-3 border-t font-bold ${gradeColor}">${result.grade}</td>
                        <td class="p-3 border-t"><span class="px-2 py-1 rounded-full text-xs font-semibold ${result.status === 'Passed' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}">${result.status}</span></td>
                        <td class="p-3 border-t">
                            <button onclick="getSubjectStudyGuide('${result.subject}', '${result.grade}')" class="text-blue-600 hover:text-blue-800 transition">
                                Tips âœ¨
                            </button>
                        </td>
                    `;
                    resultsTable.appendChild(row);
                });
            } else {
                document.getElementById('no-results').classList.remove('hidden');
            }

            // Attendance
            if (data.attendance) {
                const percentage = ((data.attendance.attended / data.attendance.total) * 100).toFixed(1);
                document.getElementById('attendance-rate-text').textContent = `${percentage}% (${data.attendance.attended}/${data.attendance.total})`;
                const chartBar = document.getElementById('attendance-chart-bar');
                chartBar.style.width = `${percentage}%`;
                if (percentage > 80) {
                    chartBar.style.backgroundColor = '#10B981'; // Green
                } else if (percentage > 60) {
                    chartBar.style.backgroundColor = '#F59E0B'; // Yellow
                } else {
                    chartBar.style.backgroundColor = '#EF4444'; // Red
                }
                chartBar.textContent = `${percentage}%`;
            } else {
                document.getElementById('attendance-rate-text').textContent = "N/A";
                document.getElementById('attendance-chart-bar').style.width = '0%';
                document.getElementById('attendance-chart-bar').textContent = '';
            }
            
            // Performance
            if (data.performance) {
                document.getElementById('gpa').textContent = data.performance.gpa || "N/A";
                document.getElementById('last-grade').textContent = data.performance.lastGrade || "N/A";
            }

            // Upcoming Events
            const eventsList = document.getElementById('events-list');
            eventsList.innerHTML = ""; // Clear existing events
            if (data.upcomingEvents && data.upcomingEvents.length > 0) {
                document.getElementById('no-events').classList.add('hidden');
                data.upcomingEvents.forEach(event => {
                    const eventItem = document.createElement('div');
                    eventItem.classList.add('flex', 'justify-between', 'items-center', 'space-x-4');
                    eventItem.innerHTML = `
                        <div>
                            <p><strong>${event.title}</strong></p>
                            <span class="text-xs text-gray-500">${event.date}</span>
                        </div>
                        <button onclick="getEventSuggestions('${event.title}')" class="bg-blue-200 text-blue-800 px-3 py-1 rounded-full text-xs font-semibold hover:bg-blue-300 transition duration-300">
                            Suggestions âœ¨
                        </button>
                    `;
                    eventsList.appendChild(eventItem);
                });
            } else {
                document.getElementById('no-events').classList.remove('hidden');
            }

            // Add event listener for the performance insight button
            const insightButton = document.getElementById('insight-button');
            if (insightButton) {
                insightButton.onclick = () => {
                    const prompt = `
                        Act as a motivational teacher. Analyze the student's data. Praise their good performance. Identify weak subjects based on their results and give three specific and actionable tips to improve them. Your suggestions should be encouraging and easy to follow. Respond in English.
                        Student Data:
                        - Name: ${data.name}
                        - Major: ${data.major}
                        - GPA: ${data.performance.gpa}
                        - Last Exam Grade: ${data.performance.lastGrade}
                        - Results: ${JSON.stringify(data.results)}
                    `;
                    getInsights(prompt, 'Student Insights');
                };
            }
        }

        // New function to get study guide for a subject
        function getSubjectStudyGuide(subject, grade) {
            const prompt = `
            Act as an expert teacher. Analyze why this student got a grade of ${grade} in ${subject}. Respond in English.
            If the grade is A or B, praise them and recommend three advanced topics or resources to deepen their knowledge.
            If the grade is C or D, identify their weaknesses and provide three specific and effective study tips to overcome them.
            `;
            getInsights(prompt, `${subject} Study Guide`);
        }

        // New function to get suggestions for an upcoming event
        function getEventSuggestions(eventTitle) {
            const prompt = `
            Act as an event planner. Give some preparation tips for the event: ${eventTitle}.
            Provide at least two tips to help them prepare for the event.
            Your suggestions must be concise and in English.
            `;
            getInsights(prompt, `Suggestions for ${eventTitle}`);
        }
        
        // --- Gemini API Functions ---

        async function getInsights(prompt, title) {
            const modal = document.getElementById('insight-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalContent = document.getElementById('modal-content');
            const loadingIndicator = document.getElementById('modal-loading');
            const audioControls = document.getElementById('audio-controls');
            
            modalTitle.textContent = title;
            modalContent.innerHTML = '';
            audioControls.classList.add('hidden');
            modal.classList.remove('hidden');
            modalContent.classList.add('hidden');
            loadingIndicator.classList.remove('hidden');

            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            try {
                const payload = {
                    contents: [{ parts: [{ text: prompt }] }]
                };
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                const text = result?.candidates?.[0]?.content?.parts?.[0]?.text || "Sorry, the analysis could not be generated at this time.";
                
                modalContent.innerHTML = `<p>${text.replace(/\n/g, '<br>')}</p>`;
                audioControls.classList.remove('hidden');
                document.getElementById('play-audio-btn').onclick = () => textToSpeech(text);
                
            } catch (error) {
                modalContent.innerHTML = `<p class="text-red-500">Sorry, an error occurred while generating the analysis. Please try again.</p>`;
                console.error('Error fetching from Gemini API:', error);
            } finally {
                loadingIndicator.classList.add('hidden');
                modalContent.classList.remove('hidden');
            }
        }

        async function textToSpeech(text) {
            const playButton = document.getElementById('play-audio-btn');
            const audioLoading = document.getElementById('audio-loading');
            
            playButton.classList.add('hidden');
            audioLoading.classList.remove('hidden');

            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;

            try {
                const payload = {
                    contents: [{ parts: [{ text: text }] }],
                    generationConfig: {
                        responseModalities: ["AUDIO"],
                        speechConfig: {
                            voiceConfig: {
                                prebuiltVoiceConfig: { voiceName: "Kore" }
                            }
                        }
                    },
                    model: "gemini-2.5-flash-preview-tts"
                };
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                const part = result?.candidates?.[0]?.content?.parts?.[0];
                const audioData = part?.inlineData?.data;
                const mimeType = part?.inlineData?.mimeType;

                if (audioData && mimeType && mimeType.startsWith("audio/L16")) {
                    const sampleRateMatch = mimeType.match(/rate=(\d+)/);
                    const sampleRate = sampleRateMatch ? parseInt(sampleRateMatch[1], 10) : 16000;
                    
                    const pcmData = base64ToArrayBuffer(audioData);
                    const wavBlob = pcmToWav(pcmData, sampleRate);
                    const audioUrl = URL.createObjectURL(wavBlob);
                    
                    const audio = new Audio(audioUrl);
                    audio.play().catch(e => console.error("Audio playback failed:", e));

                    audio.onended = () => {
                        playButton.classList.remove('hidden');
                        audioLoading.classList.add('hidden');
                    };
                } else {
                    console.error("Invalid audio response format");
                }
            } catch (error) {
                console.error('Error fetching from Gemini TTS API:', error);
                playButton.classList.remove('hidden');
                audioLoading.classList.add('hidden');
            }
        }
        
        // Event listener to close the modal
        document.getElementById('close-modal-btn').addEventListener('click', () => {
            document.getElementById('insight-modal').classList.add('hidden');
        });
    </script>
</body>
</html>
